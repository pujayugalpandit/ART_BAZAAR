<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Artwork - Art Bazaar</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f7f7f7;
      min-height: 100vh;
    }

    /* NAVBAR */
    .navbar {
      background: linear-gradient(45deg, #9333ea, #ec4899);
      color: white;
      padding: 16px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navbar .logo {
      font-size: 22px;
      font-weight: bold;
    }

    .back-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 8px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      font-weight: 600;
    }

    .back-btn:hover { background: rgba(255,255,255,0.3); }

    /* HERO */
    .hero {
      background: linear-gradient(45deg, #9333ea, #ec4899);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .hero h1 { font-size: 28px; font-weight: 700; }
    .hero p { margin-top: 6px; opacity: 0.9; }

    /* CONTAINER */
    .container {
      max-width: 700px;
      margin: 30px auto;
      padding: 0 20px 60px;
    }

    /* CARD */
    .edit-card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    /* CURRENT IMAGE PREVIEW */
    .current-image-section {
      margin-bottom: 28px;
    }

    .current-image-section label {
      display: block;
      font-weight: 600;
      color: #444;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .current-image-wrapper {
      position: relative;
      display: inline-block;
    }

    .current-image-wrapper img {
      width: 100%;
      max-width: 300px;
      height: 200px;
      object-fit: cover;
      border-radius: 12px;
      border: 3px solid #e8d5ff;
      display: block;
    }

    .image-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 6px;
    }

    /* FORM */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #444;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e8e8e8;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.2s;
      background: #fafafa;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #9333ea;
      background: white;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 500px) {
      .form-row { grid-template-columns: 1fr; }
    }

    /* FILE INPUT */
    .file-input-wrapper {
      border: 2px dashed #d8b4fe;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      background: #fdf4ff;
      cursor: pointer;
      transition: 0.2s;
    }

    .file-input-wrapper:hover {
      border-color: #9333ea;
      background: #f5e8ff;
    }

    .file-input-wrapper input[type="file"] {
      display: none;
    }

    .file-input-wrapper .upload-icon { font-size: 28px; }
    .file-input-wrapper p { color: #888; font-size: 14px; margin-top: 6px; }
    .file-input-wrapper .file-name { color: #9333ea; font-weight: 600; margin-top: 6px; font-size: 13px; }

    /* NEW IMAGE PREVIEW */
    #newImagePreview {
      display: none;
      margin-top: 12px;
    }

    #newImagePreview img {
      width: 100%;
      max-width: 200px;
      height: 140px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #9333ea;
    }

    /* BUTTONS */
    .btn-row {
      display: flex;
      gap: 12px;
      margin-top: 28px;
    }

    .btn-save {
      flex: 1;
      padding: 14px;
      background: linear-gradient(45deg, #9333ea, #ec4899);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
    }

    .btn-save:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-save:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .btn-cancel {
      padding: 14px 24px;
      background: #f0f0f0;
      color: #555;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-cancel:hover { background: #e5e5e5; }

    /* LOADING SPINNER */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.8);
      z-index: 999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 16px;
    }

    .spinner {
      width: 48px; height: 48px;
      border: 5px solid #e8d5ff;
      border-top-color: #9333ea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-overlay p { color: #9333ea; font-weight: 600; font-size: 16px; }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 20px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      font-size: 15px;
      z-index: 1000;
      transform: translateY(80px);
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 320px;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success { background: linear-gradient(45deg, #9333ea, #ec4899); }
    .toast.error { background: #ef4444; }

    /* SKELETON LOADER */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite;
      border-radius: 8px;
      height: 44px;
      margin-bottom: 20px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>

<body>

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <p id="loadingText">Saving changes...</p>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- NAVBAR -->
<nav class="navbar">
  <div class="logo">üé® Art Bazaar</div>
  <a href="dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
</nav>

<!-- HERO -->
<div class="hero">
  <h1>Edit Artwork</h1>
  <p>Update your artwork details below</p>
</div>

<!-- MAIN CONTENT -->
<div class="container">
  <div class="edit-card">

    <!-- CURRENT IMAGE -->
    <div class="current-image-section">
      <label>Current Image</label>
      <div class="current-image-wrapper">
        <img id="currentImage" src="" alt="Current artwork" />
        <span class="image-badge">Current</span>
      </div>
    </div>

    <!-- FORM -->
    <form id="editForm">

      <div class="form-group">
        <label for="title">Title *</label>
        <input type="text" id="title" placeholder="Artwork title" required />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="price">Price (‚Çπ) *</label>
          <input type="number" id="price" placeholder="e.g. 5000" min="1" required />
        </div>

        <div class="form-group">
          <label for="category">Category *</label>
          <select id="category" required>
            <option value="">Select Category</option>
            <option value="Painting">Painting</option>
            <option value="Sculpture">Sculpture</option>
            <option value="Digital Art">Digital Art</option>
            <option value="Photography">Photography</option>
            <option value="Contemporary">Contemporary</option>
            <option value="Mixed Media">Mixed Media</option>
            <option value="Print">Print</option>
            <option value="Illustration">Illustration</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" placeholder="Describe your artwork..."></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="dimensions">Dimensions</label>
          <input type="text" id="dimensions" placeholder='e.g. 24" x 36"' />
        </div>

        <div class="form-group">
          <label for="medium">Medium</label>
          <input type="text" id="medium" placeholder="e.g. Oil on canvas" />
        </div>
      </div>

      <!-- NEW IMAGE UPLOAD -->
      <div class="form-group">
        <label>Replace Image <span style="color:#aaa; font-weight:400;">(optional)</span></label>
        <div class="file-input-wrapper" onclick="document.getElementById('newImage').click()">
          <input type="file" id="newImage" accept="image/*" />
          <div class="upload-icon">üìÅ</div>
          <p>Click to choose a new image</p>
          <div class="file-name" id="fileName">No file chosen</div>
        </div>

        <div id="newImagePreview">
          <p style="font-size:13px; color:#888; margin-bottom:6px;">New image preview:</p>
          <img id="previewImg" src="" alt="New image preview" />
        </div>
      </div>

      <!-- BUTTONS -->
      <div class="btn-row">
        <a href="dashboard.html" class="btn-cancel">Cancel</a>
        <button type="submit" class="btn-save" id="saveBtn">üíæ Save Changes</button>
      </div>

    </form>
  </div>
</div>

<script>
  let artworkId = null;
  let currentImageUrl = null;

  /* ======== ON LOAD ======== */
  document.addEventListener("DOMContentLoaded", async () => {

    // Auth check
    const { data: sessionData } = await supabase.auth.getSession();
    const user = sessionData.session?.user;
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    // Get artwork ID from URL
    const params = new URLSearchParams(window.location.search);
    artworkId = params.get("id");

    if (!artworkId) {
      showToast("No artwork ID found", "error");
      setTimeout(() => window.location.href = "dashboard.html", 2000);
      return;
    }

    await loadArtwork(user.id);

    // File input preview
    document.getElementById("newImage").addEventListener("change", handleImagePreview);

    // Form submit
    document.getElementById("editForm").addEventListener("submit", handleSave);
  });

  /* ======== LOAD ARTWORK ======== */
  async function loadArtwork(userId) {
    const { data, error } = await supabase
      .from("artworks")
      .select("*")
      .eq("id", artworkId)
      .eq("artist_id", userId)   // security: only owner can edit
      .single();

    if (error || !data) {
      showToast("Artwork not found or access denied", "error");
      setTimeout(() => window.location.href = "dashboard.html", 2000);
      return;
    }

    // Populate form
    document.getElementById("title").value        = data.title        || "";
    document.getElementById("price").value        = data.price        || "";
    document.getElementById("description").value  = data.description  || "";
    document.getElementById("dimensions").value   = data.dimensions   || "";
    document.getElementById("medium").value       = data.medium       || "";

    // Set category dropdown
    const categorySelect = document.getElementById("category");
    for (let opt of categorySelect.options) {
      if (opt.value === data.category) {
        opt.selected = true;
        break;
      }
    }

    // Current image
    currentImageUrl = data.image_url;
    const img = document.getElementById("currentImage");
    if (data.image_url) {
      img.src = data.image_url;
      img.onerror = () => img.src = "https://via.placeholder.com/300x200?text=No+Image";
    } else {
      img.src = "https://via.placeholder.com/300x200?text=No+Image";
    }
  }

  /* ======== IMAGE PREVIEW ======== */
  function handleImagePreview(e) {
    const file = e.target.files[0];
    if (!file) return;

    document.getElementById("fileName").textContent = file.name;

    const reader = new FileReader();
    reader.onload = (ev) => {
      document.getElementById("previewImg").src = ev.target.result;
      document.getElementById("newImagePreview").style.display = "block";
    };
    reader.readAsDataURL(file);
  }

  /* ======== SAVE CHANGES ======== */
  async function handleSave(e) {
    e.preventDefault();

    const saveBtn = document.getElementById("saveBtn");
    saveBtn.disabled = true;
    saveBtn.innerText = "Saving...";
    showLoading("Saving changes...");

    try {
      const { data: sessionData } = await supabase.auth.getSession();
      const user = sessionData.session?.user;

      let image_url = currentImageUrl;

      // Upload new image if selected
      const newImageFile = document.getElementById("newImage").files[0];
      if (newImageFile) {
        showLoading("Uploading new image...");

        const filePath = `${user.id}/${Date.now()}_${newImageFile.name}`;
        const { error: uploadError } = await supabase.storage
          .from("artworks")
          .upload(filePath, newImageFile);

        if (uploadError) {
          throw new Error("Image upload failed: " + uploadError.message);
        }

        const { data: urlData } = supabase.storage
          .from("artworks")
          .getPublicUrl(filePath);

        image_url = urlData.publicUrl;
        showLoading("Saving changes...");
      }

      // Update artwork in database
      const { error } = await supabase
        .from("artworks")
        .update({
          title:       document.getElementById("title").value,
          price:       parseFloat(document.getElementById("price").value),
          category:    document.getElementById("category").value,
          description: document.getElementById("description").value,
          dimensions:  document.getElementById("dimensions").value,
          medium:      document.getElementById("medium").value,
          image_url:   image_url,
        })
        .eq("id", artworkId)
        .eq("artist_id", user.id);

      if (error) throw new Error(error.message);

      hideLoading();
      showToast("‚úÖ Artwork updated successfully!", "success");

      // Redirect back to dashboard after short delay
      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 1500);

    } catch (err) {
      hideLoading();
      showToast("‚ùå " + err.message, "error");
      saveBtn.disabled = false;
      saveBtn.innerText = "üíæ Save Changes";
    }
  }

  /* ======== HELPERS ======== */
  function showLoading(text = "Loading...") {
    document.getElementById("loadingText").textContent = text;
    document.getElementById("loadingOverlay").style.display = "flex";
  }

  function hideLoading() {
    document.getElementById("loadingOverlay").style.display = "none";
  }

  function showToast(msg, type = "success") {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.className = `toast ${type} show`;
    setTimeout(() => toast.className = "toast", 3500);
  }
</script>

</body>
</html>